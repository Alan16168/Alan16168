<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC省房东管理系统 - API测试页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .response-box {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
        }

        .response-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .success {
            color: #28a745;
            font-weight: 600;
        }

        .error {
            color: #dc3545;
            font-weight: 600;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box strong {
            color: #2196F3;
        }

        .token-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-family: monospace;
        }

        .chat-message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            line-height: 1.6;
        }

        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .chat-message.assistant {
            background: #f1f3f5;
            margin-right: 20%;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .test-questions {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .test-questions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .test-questions button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-questions button:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 BC省房东管理系统</h1>
            <p>API测试界面 - 完整功能演示</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator status-online" id="statusIndicator"></span>
                <span id="statusText">检查中...</span>
            </div>
        </div>

        <div class="content">
            <!-- 系统信息 -->
            <div class="info-box">
                <strong>📌 使用说明：</strong><br>
                1. 先点击"检查系统状态"确认后端运行正常<br>
                2. 注册一个新用户或使用演示账户登录<br>
                3. 登录后可以测试AI聊天、查看历史等功能<br>
                4. Token会自动保存，刷新页面后仍然有效
            </div>

            <!-- 第一部分：系统状态 -->
            <div class="section">
                <h2>🔍 1. 系统状态检查</h2>
                <button class="btn" onclick="checkHealth()">检查系统状态</button>
                <div id="healthResponse" class="response-box" style="display:none;"></div>
            </div>

            <!-- 第二部分：用户认证 -->
            <div class="section">
                <h2>🔐 2. 用户认证</h2>
                
                <div class="grid">
                    <div>
                        <h3>注册新用户</h3>
                        <div class="input-group">
                            <label>姓名</label>
                            <input type="text" id="regName" value="测试用户" placeholder="请输入姓名">
                        </div>
                        <div class="input-group">
                            <label>邮箱</label>
                            <input type="email" id="regEmail" placeholder="test@example.com">
                        </div>
                        <div class="input-group">
                            <label>密码</label>
                            <input type="password" id="regPassword" value="test123456" placeholder="至少6位">
                        </div>
                        <div class="input-group">
                            <label>语言</label>
                            <select id="regLanguage">
                                <option value="zh">中文</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <button class="btn" onclick="register()">注册</button>
                    </div>

                    <div>
                        <h3>用户登录</h3>
                        <div class="input-group">
                            <label>邮箱</label>
                            <input type="email" id="loginEmail" placeholder="test@example.com">
                        </div>
                        <div class="input-group">
                            <label>密码</label>
                            <input type="password" id="loginPassword" value="test123456" placeholder="密码">
                        </div>
                        <button class="btn" onclick="login()">登录</button>
                        <button class="btn btn-secondary" onclick="clearToken()">清除Token</button>
                    </div>
                </div>

                <div id="authResponse" class="response-box" style="display:none;"></div>
                <div id="tokenDisplay" style="display:none;">
                    <strong>当前Token：</strong>
                    <div class="token-display" id="currentToken"></div>
                </div>
            </div>

            <!-- 第三部分：AI聊天 -->
            <div class="section">
                <h2>🤖 3. AI智能聊天</h2>
                
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label>输入问题</label>
                            <textarea id="chatMessage" placeholder="例如：BC省租客可以养宠物吗？"></textarea>
                        </div>
                        <div class="input-group">
                            <label>语言</label>
                            <select id="chatLanguage">
                                <option value="zh">中文</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <button class="btn" onclick="sendChat()">发送消息</button>
                        <button class="btn btn-secondary" onclick="clearChat()">清空对话</button>
                    </div>

                    <div class="test-questions">
                        <h3>📝 快速测试问题</h3>
                        <button onclick="quickTest('BC省租客可以养宠物吗？', 'zh')">🐕 宠物政策</button>
                        <button onclick="quickTest('房东如何涨租？', 'zh')">💰 租金上涨</button>
                        <button onclick="quickTest('押金最多可以收多少？', 'zh')">🏦 押金规定</button>
                        <button onclick="quickTest('租客有什么权利？', 'zh')">⚖️ 租客权利</button>
                        <button onclick="quickTest('Can tenants have pets?', 'en')">🇬🇧 Pet Policy</button>
                    </div>
                </div>

                <div id="chatResponse" class="response-box" style="display:none;"></div>
            </div>

            <!-- 第四部分：聊天历史 -->
            <div class="section">
                <h2>📜 4. 聊天历史</h2>
                <button class="btn" onclick="getChatHistory()">获取聊天历史</button>
                <button class="btn btn-secondary" onclick="getSessions()">获取所有会话</button>
                <div id="historyResponse" class="response-box" style="display:none;"></div>
            </div>

            <!-- 第五部分：BC省表格 -->
            <div class="section">
                <h2>📋 5. BC省租赁表格</h2>
                <button class="btn" onclick="getForms()">获取表格列表</button>
                <div id="formsResponse" class="response-box" style="display:none;"></div>
            </div>

            <!-- 第六部分：背景调查 -->
            <div class="section">
                <h2>🔍 6. 租客背景调查</h2>
                <div class="input-group">
                    <label>姓</label>
                    <input type="text" id="bgFirstName" value="张" placeholder="First Name">
                </div>
                <div class="input-group">
                    <label>名</label>
                    <input type="text" id="bgLastName" value="三" placeholder="Last Name">
                </div>
                <div class="input-group">
                    <label>邮箱</label>
                    <input type="email" id="bgEmail" value="zhangsan@example.com" placeholder="Email">
                </div>
                <button class="btn" onclick="submitBackgroundCheck()">提交背景调查</button>
                <button class="btn btn-secondary" onclick="getBackgroundHistory()">查看历史</button>
                <div id="bgResponse" class="response-box" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentToken = localStorage.getItem('authToken') || '';
        let sessionId = 'test-session-' + Date.now();

        // 页面加载时检查token和系统状态
        window.onload = function() {
            if (currentToken) {
                showToken();
            }
            checkHealth();
            // 生成随机邮箱
            document.getElementById('regEmail').value = 'test' + Date.now() + '@example.com';
        };

        function showToken() {
            document.getElementById('tokenDisplay').style.display = 'block';
            document.getElementById('currentToken').textContent = currentToken;
        }

        function clearToken() {
            localStorage.removeItem('authToken');
            currentToken = '';
            document.getElementById('tokenDisplay').style.display = 'none';
            showResponse('authResponse', '<span class="success">✅ Token已清除</span>');
        }

        function showResponse(elementId, content) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.innerHTML = content;
        }

        function showLoading(elementId) {
            showResponse(elementId, '<div class="loading"></div> 处理中...');
        }

        async function checkHealth() {
            showLoading('healthResponse');
            try {
                const response = await fetch(`${API_URL}/api/health`);
                const data = await response.json();
                
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (data.status === 'OK') {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = '系统运行正常';
                    showResponse('healthResponse', 
                        `<span class="success">✅ 系统运行正常</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error('系统异常');
                }
            } catch (error) {
                document.getElementById('statusIndicator').className = 'status-indicator status-offline';
                document.getElementById('statusText').textContent = '系统离线';
                showResponse('healthResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function register() {
            showLoading('authResponse');
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const language = document.getElementById('regLanguage').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, language })
                });
                const data = await response.json();

                if (data.success) {
                    currentToken = data.token;
                    localStorage.setItem('authToken', currentToken);
                    showToken();
                    document.getElementById('loginEmail').value = email;
                    showResponse('authResponse', 
                        `<span class="success">✅ 注册成功！</span>
                        <pre>${JSON.stringify(data.user, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('authResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function login() {
            showLoading('authResponse');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (data.success) {
                    currentToken = data.token;
                    localStorage.setItem('authToken', currentToken);
                    showToken();
                    showResponse('authResponse', 
                        `<span class="success">✅ 登录成功！</span>
                        <pre>${JSON.stringify(data.user, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('authResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function sendChat() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('chatResponse');
            const message = document.getElementById('chatMessage').value;
            const language = document.getElementById('chatLanguage').value;

            try {
                const response = await fetch(`${API_URL}/api/chat/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ message, language, sessionId })
                });
                const data = await response.json();

                if (data.success) {
                    let html = `<div class="chat-message user"><strong>您：</strong><br>${message}</div>`;
                    html += `<div class="chat-message assistant"><strong>AI助手：</strong><br>${data.message}</div>`;
                    
                    if (data.sources && data.sources.length > 0) {
                        html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">`;
                        html += `<strong>📚 参考来源：</strong><br>`;
                        data.sources.forEach(source => {
                            html += `• ${source.documentName} (相关度: ${(source.relevanceScore * 100).toFixed(0)}%)<br>`;
                        });
                        html += `</div>`;
                    }
                    
                    showResponse('chatResponse', html);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('chatResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        function quickTest(question, language) {
            document.getElementById('chatMessage').value = question;
            document.getElementById('chatLanguage').value = language;
            sendChat();
        }

        function clearChat() {
            document.getElementById('chatResponse').innerHTML = '';
            document.getElementById('chatMessage').value = '';
        }

        async function getChatHistory() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('historyResponse');
            try {
                const response = await fetch(`${API_URL}/api/chat/history/${sessionId}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    let html = `<span class="success">✅ 共 ${data.messages.length} 条消息</span><br><br>`;
                    data.messages.forEach(msg => {
                        const role = msg.role === 'user' ? '👤 用户' : '🤖 AI';
                        html += `<div class="chat-message ${msg.role}">`;
                        html += `<strong>${role}：</strong><br>${msg.content}`;
                        html += `</div>`;
                    });
                    showResponse('historyResponse', html);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('historyResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function getSessions() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('historyResponse');
            try {
                const response = await fetch(`${API_URL}/api/chat/sessions`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    showResponse('historyResponse', 
                        `<span class="success">✅ 会话列表获取成功</span>
                        <pre>${JSON.stringify(data.sessions, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('historyResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function getForms() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('formsResponse');
            try {
                const response = await fetch(`${API_URL}/api/forms`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    showResponse('formsResponse', 
                        `<span class="success">✅ 表格列表获取成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('formsResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function submitBackgroundCheck() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('bgResponse');
            const firstName = document.getElementById('bgFirstName').value;
            const lastName = document.getElementById('bgLastName').value;
            const email = document.getElementById('bgEmail').value;

            try {
                const response = await fetch(`${API_URL}/api/background-check/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ 
                        firstName, 
                        lastName, 
                        email,
                        phone: '778-123-4567',
                        currentAddress: '123 Main St, Vancouver, BC'
                    })
                });
                const data = await response.json();

                if (data.success) {
                    showResponse('bgResponse', 
                        `<span class="success">✅ 背景调查请求成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    // Premium功能限制是预期的
                    showResponse('bgResponse', 
                        `<span style="color: #ff9800;">⚠️ ${data.message}</span>
                        <p>这是正常的权限控制，需要Premium或Admin权限。</p>`
                    );
                }
            } catch (error) {
                showResponse('bgResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }

        async function getBackgroundHistory() {
            if (!currentToken) {
                alert('请先登录！');
                return;
            }

            showLoading('bgResponse');
            try {
                const response = await fetch(`${API_URL}/api/background-check/history`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    showResponse('bgResponse', 
                        `<span class="success">✅ 历史记录获取成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`
                    );
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showResponse('bgResponse', 
                    `<span class="error">❌ 错误：${error.message}</span>`
                );
            }
        }
    </script>
</body>
</html>
